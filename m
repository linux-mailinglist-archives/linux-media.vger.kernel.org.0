Return-Path: <linux-media-owner@vger.kernel.org>
X-Original-To: lists+linux-media@lfdr.de
Delivered-To: lists+linux-media@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.lfdr.de (Postfix) with ESMTP id 81945DA9E4
	for <lists+linux-media@lfdr.de>; Thu, 17 Oct 2019 12:25:19 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1730786AbfJQKZT (ORCPT <rfc822;lists+linux-media@lfdr.de>);
        Thu, 17 Oct 2019 06:25:19 -0400
Received: from lb1-smtp-cloud7.xs4all.net ([194.109.24.24]:43169 "EHLO
        lb1-smtp-cloud7.xs4all.net" rhost-flags-OK-OK-OK-OK)
        by vger.kernel.org with ESMTP id S1726248AbfJQKZS (ORCPT
        <rfc822;linux-media@vger.kernel.org>);
        Thu, 17 Oct 2019 06:25:18 -0400
Received: from [IPv6:2001:420:44c1:2577:5195:3526:c85b:688a]
 ([IPv6:2001:420:44c1:2577:5195:3526:c85b:688a])
        by smtp-cloud7.xs4all.net with ESMTPA
        id L2xyi1LQCo1ZhL2y2i6MvI; Thu, 17 Oct 2019 12:25:16 +0200
From:   Hans Verkuil <hverkuil@xs4all.nl>
Subject: [ANN v2] Media sessions in Lyon in October: codecs
To:     Linux Media Mailing List <linux-media@vger.kernel.org>,
        Boris Brezillon <boris.brezillon@collabora.com>,
        Alexandre Courbot <acourbot@chromium.org>,
        Nicolas Dufresne <nicolas@ndufresne.ca>,
        Tomasz Figa <tfiga@chromium.org>,
        Ezequiel Garcia <ezequiel@collabora.com>,
        Daniel Gomez <daniel@qtec.com>,
        Dafna Hirschfeld <dafna.hirschfeld@collabora.com>,
        Eugen Hristev <Eugen.Hristev@microchip.com>,
        Paul Kocialkowski <paul.kocialkowski@bootlin.com>,
        Helen Koike <helen.koike@collabora.com>,
        Michael Tretter <m.tretter@pengutronix.de>
Cc:     Jacopo Mondi <jacopo+renesas@jmondi.org>,
        Laurent Pinchart <laurent.pinchart@ideasonboard.com>,
        Maxime Ripard <maxime.ripard@bootlin.com>,
        Dave Stevenson <dave.stevenson@raspberrypi.org>,
        Stanimir Varbanov <stanimir.varbanov@linaro.org>
Message-ID: <f35e5aaa-cb3d-a0ad-ebc8-ed9410eb33b1@xs4all.nl>
Date:   Thu, 17 Oct 2019 12:25:10 +0200
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.8.0
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-CMAE-Envelope: MS4wfBnPY2DzsjXvp3jeoX4hxnAayy5zjDeNTaQNEZZZljhq+/2s7RhKCar1SxrULQLulMdsuVESZqQe6YGeMpJ/ZGeryyhlHbEdXOxoabNGP0QDPSSvEB8/
 fjSMUkxLY4GlUDTVqQSuU+hXgZGNauWLH2R397gh4JNoPZEr/cWxP6tKZ2bJZ9CapP+KL+Zzc8+mls0oKQEMc7b9MmHonJziSK+PA8rQepDaDFQH0cgX/Axx
 sol3RvYFwH9vwELdcJml5OgfrgdAX38xH6iDNl6PcH/bakjrsgsRPwC9RecEhTbxMHYkSJrCRvpQ46uG5Vz435IUAD8WJ/DOZa2YCbnmli08nyxjr8V2SJpl
 DitDjPbjLqjL60XCI7DzVp0OS3bN/oIDL6jnckONuK7UVr84S0NTg0MMeRJiK+OtCj/Fi4ea6HJDvsE7aJl9VSm82HQAR7LHOhXtN1p7Hr9DBECxiu/WAoyj
 LSLTFsE4pvgfYbkY+cS7ddzawq8BSMfG2MGCucj5nmBaJYWiJO4ORrBZqqPAz3R1tnnG1J2E/hnv0ocxFhxpkQdEmZanINUZXc8ZLnW/zju5ew49WH3JSyng
 HOb99zF4fhtPCYVjtjZIS63lMIOmnI4IvuJ47jrDK2XLvceck5XtJ8VwzbULBXRz6+7QgVXhMiu8+bzLdeeR+DhREI9arB3A6D8yzRJW581Y758stqpQTJvt
 S/atnoP69zq5hjKrxUfiz7SLRo6PZprJvM4mPTtf00UsrQDBVJsbRTcFImdIEroEAjDKwpfcYeSs5pwLm+UETyVXeRCLXaBDpBHVY9sqddy9VgMtnF5LZ7em
 LpAuvGVRc9W/IwrIL4xo2rU6FyNJ3fVOcvgsG4OgOJ+ExTp+mrdS48BSXm7zBdJVCDh/jiSepJKWOrv0E3M=
Sender: linux-media-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-media.vger.kernel.org>
X-Mailing-List: linux-media@vger.kernel.org

Hi all,

Since we have three separate half-day sessions for different topics I decided
to split the announcement for this in three emails as well, so these things
can be discussed in separate threads.

All sessions are in room Terreaux VIP Lounge - Level 0.
There is a maximum of 15 people.

The first session deals with the codec API and is on Tuesday morning from
8:30 to 12:00 (we have to vacate the room at that time). Note that 8:30
start time!

Confirmed attendees for this session:

Boris Brezillon <boris.brezillon@collabora.com>
Alexandre Courbot <acourbot@chromium.org>
Nicolas Dufresne <nicolas@ndufresne.ca>
Tomasz Figa <tfiga@chromium.org>
Ezequiel Garcia <ezequiel@collabora.com>
Dafna Hirschfeld <dafna.hirschfeld@collabora.com>
Paul Kocialkowski <paul.kocialkowski@bootlin.com>
Maxime Ripard <mripard@kernel.org>
Dave Stevenson <dave.stevenson@raspberrypi.org>
Michael Tretter <m.tretter@pengutronix.de>
Stanimir Varbanov <stanimir.varbanov@linaro.org>
Hans Verkuil <hverkuil@xs4all.nl>

Please let me know asap if I missed someone, or if you are listed, but
can't join for some reason.

There are three seats left, and I have five on the 'just interested'
list:

Daniel Gomez <daniel@qtec.com>
Eugen Hristev <Eugen.Hristev@microchip.com>
Helen Koike <helen.koike@collabora.com>
Jacopo Mondi <jacopo@jmondi.org>
Laurent Pinchart <laurent.pinchart@ideasonboard.com>

If you still want to join, please mail me. First come, first served :-)

Agenda:

Note: I didn't assign start times, we'll just go through these items one-by-one.

- Status of any pending patches related to codec support.
  I'll provide a list of those patches by the end of next week so we
  can go through them.

- Requirements of moving codec drivers out of staging.

- Finalize the stateful encoder API. There are two pieces that need
  to be defined:

  1) Setting the frame rate so bitrate control can make sense, since
     they need to know this information. This is also relevant for the
     stateless codec (and this may have to change on a per-frame basis
     for stateless codecs!).

     This can either be implemented via ENUM_FRAMEINTERVALS for the coded
     pixelformats plus S_PARM support, or we just add a new control for this.
     E.g. V4L2_CID_MPEG_VIDEO_FRAME_INTERVAL using struct v4l2_fract.

     I am inclined to go with a control, since the semantics don't really
     match ENUM_FRAMEINTERVALS/S_PARM. These ioctls still need to be supported
     for legacy drivers. Open question: some drivers (mediatek, hva, coda)
     require S_PARM(OUTPUT), some (venus) allow both S_PARM(CAPTURE) and
     S_PARM(OUTPUT). I am inclined to allow both since this is not a CAPTURE
     vs OUTPUT thing, it is global to both queues.

  2) Interactions between OUTPUT and CAPTURE formats.

     The main problem is what to do if the capture sizeimage is too small
     for the OUTPUT resolution when streaming starts.

     Proposal: width and height of S_FMT(OUTPUT) plus max-bitrate plus frame
     interval plus key frame interval info are used to calculate a minimum
     CAPTURE sizeimage (app may request more). This is codec-specific, I think,
     so it should be possible to provide helper functions for this.

     However, it may be quite difficult to make a good calculation. I just
     don't know enough to determine this.

     V4L2_FMT_FLAG_DYN_RESOLUTION is always cleared for codec formats
     for the encoder (i.e. we don't support mid-stream resolution
     changes for now) and V4L2_EVENT_SOURCE_CHANGE is not
     supported.

     Of course, if we start to support mid-stream resolution
     changes (or other changes that require a source change event),
     then this flag should be set by the encoder driver and
     documentation on how to handle the source change event should
     be documented in the encoder spec. I prefer to postpone this
     until we have an encoder than can actually do mid-stream
     resolution changes.

     If sizeimage of the OUTPUT is too small for the CAPTURE
     resolution and V4L2_EVENT_SOURCE_CHANGE is not supported,
     then the second STREAMON (either CAPTURE or OUTPUT) will
     return -ENOMEM since there is not enough memory to do the
     encode.

     If V4L2_FMT_FLAG_DYN_RESOLUTION is cleared (i.e. that is
     the case for all current encoders), then any bitrate controls
     will be limited in range to what the current state (CAPTURE and
     OUTPUT formats and frame interval) supports.

- Stateless encoder support

  Overall goals:

  - Find out if there is a common set of per frame encoding parameters
  - Find out if bitrate control can be reused for multiple HW
  - Decide if we do in-kernel bitrate control or not
  - Decide if we keep bitstream header crafting external (unlike Hantro
    JPEG encoder, but like VAAPI)
  - Decide if we provide (and maintain) a libv4l2 plugin like ChromeOS
    folks opted for.

  I hope Nicolas and Tomasz can prepare for this.

  The one requirement that Cisco would have for these devices is that
  we must be able to do per-frame bitrate control from userspace.

Regards,

	Hans
